---
title: "grad_assignment"
author: "Pablo Suarez"
date: "2023-11-24"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## INTRODUCTION

Welcome to Pablo Suarez's markdown file for the JOUR772 Graduate Student
Assignment. Below, I am analyzing the Reported Sewer Overflows data set
provided by the Maryland Department of the Environment. This data set
contains information regarding reported sewer overflows across the state
of Maryland from January 1, 2005 through January 31, 2023.

An important note from the data set creators: "Although MDE requires
that all public sewer system owners or operators report overflows to us,
there may be incidents that were not reported. Note that overflow
amounts provided by the person reporting the overflow may be estimated
using best professional judgment or they may be actual readings from
flow measurement devices when available. Penalty information started
during 2013."

Data Profile, Scope and Limitations:

Rows -- 27,479

Columns -- 22

Who created and maintains the data? -- Maryland Department of the
Environment

Dataset Owner -- Andrew Gosden

What state program or law is connected to it? -- Unclear

What does each row represent? -- One overflow event

Columns: overflow type, municipality/facility (it occurred in), NPDES \#
(National Pollutant Discharge Elimination System identification number
for the facility or system), date discovered, time discovered, duration
(days, hours, minutes), location, zip code, collection-system, quantity
in gallons, net in gallons, cause, watershed, receiving waters, county,
notes, penalty collected, penalty comments, latitude, longitude

What is the chronological and geographic scope of this data? -- Reported
sewer overflows across the state of Maryland from January 1, 2005,
through January 31, 2023.

Newsworthy questions that I'd like to answer with this data set: 

- Which counties reported the most sewer overflows over the dataset's observed
period of time?

- Which counties had the most severe sewer overflows (by quantity, time or
both) and when did they occur? Follow-up: Which reported incidents were
highest in terms of overflow that was not collected?

- What is the average quantity of gallons of sewer overflows per event versus the estimated net in gallons?

- Can I find the percentage of reported overflows by county? (Imaginary
Example: Wicomico County accounted for 15% of sewer overflows in the
state.)

- What are the most common types of sewer overflows? Follow-up: Could I do
a percentage breakdown of this as well?

- Which Maryland watersheds have been most impacted by sewer overflows?

- (Extra work) How might the frequency or severity of these overflows
compare with Maryland rainfall data?

***Link to the data set:
<https://opendata.maryland.gov/Energy-and-Environment/Reported-Sewer-Overflows/3rgd-zjxx>***

## ***Section #1***

To begin the assignment, I loaded in several libraries that I thought might be relevant, as well as my selected data set, which I cleaned in OpenRefine.

```{r}

# Turn off scientific notation
options(scipen=999)

# Load my libraries
library(tidyverse)
library(janitor)
library(refinr)
library(lubridate)
library(dplyr)
library(readr)
library(stringi)
library(stringr)
library(hash)

```

```{r}

cleaned_sewer_overflows <- read_csv("data/cleaned_sewer_overflows.csv") |>
  clean_names() 
  
glimpse(cleaned_sewer_overflows)

```

```{r}




```

```{r}

cleaned_sewer_overflows <- cleaned_sewer_overflows |>
mutate(date_discovered = mdy(date_discovered))

```

## ***Section #2***

In this section, I attempted to answer the questions listed at the top of the markdown file. 

Q1: Which counties reported the most sewer overflows over the dataset's observed period of time?

We're starting the coding portion part of the project on an easy note. To answer this question I grouped the data by county, summarized with a new column called "overflow_count" and arranged the results in descending order. Immediately, I see that Allegany County has, by far, the most reported overflows over time with 10,653. The next highest is Baltimore City with 6,808; followed by Baltimore County with 1,892; Prince George's County with 1,470 and Montgomery County with 1,146 overflow incidents.

```{r}

cleaned_sewer_overflows |>
  group_by(county) |>
  summarise(overflow_count = n()) |>
  arrange(desc(overflow_count))

```

Q2: What is the percentage of reported overflows by county?

Adding to the last codeblock, this question enables me to show the percentage breakdown of overflow incidents by county. I did this by mutating a new column called incident_pct which took the overflow incident count of a specific county, divided it by the sum of all overflow incidents and multiplied the results by 100 to get the percentage.

Unsurprisingly, the results fall in line with what I observed in the first question. Allegany County had the highest share of incidents with 38.7 percent, followed by Baltimore City with 24.7 percent, then it drops significantly with Baltimore County at 6.88 percent and Prince George's County with 5.3 percent. 

```{r}

cleaned_sewer_overflows |>
  group_by(county) |>
   summarise(overflow_count = n()) |>
  mutate(incident_pct = overflow_count / sum(overflow_count) * 100) |>
  arrange(desc(incident_pct))

```

Q2 Follow-up: What about the distribution of overflows by county and year?

To complete this question I needed to separate the date_discovered column into separate columns in order to be able to group the data by year. I used the separate function and divided the original column into three columns: year, month and day. Then I was able to group the data by county and year, and then summarize with a column called overflow_count adding up a specific county's number of overflow incidents in a specific year.

Then, I used the ungroup function to section off the initial portion of the code block. I mutated a new column called total_count_year, which is the sum of all reported overflow incidents among counties for a specific year. Calculating that total allowed me to add another column showing the percentage for how much a certain county's number of overflows accounted for the total overflows among all counties for that year. I followed a similar process to add a column after that showing the percentage of a county's overflow incidents from a certain year in relation to its total number of incidents over all recorded years in the data set.

Completing these steps allowed me to see which counties had particularly severe years in terms of overflow incidents in relation to other counties and historically.

In terms of newsworthy results, Allegany County in 2007 accounted for 49 percent of all overflow incidents during that year. In 2011, Allegany County saw nearly eight percent of its total overflow incidents occur. Baltimore City accounted for 44 percent of incidents in 2021.

```{r}

cleaned_sewer_overflows |>
  separate(date_discovered, into = c("year", "month", "day"), sep = "-") |>
    group_by(county, year) |>
      summarize(overflow_count = n()) |>
  ungroup() |>
  group_by(year) |>
    mutate(total_count_year = sum(overflow_count),
         incident_pct_that_year = overflow_count / total_count_year * 100) |>
  ungroup() |>
    group_by(county) |>
      mutate(total_count_all_years = sum(overflow_count),
         incident_pct_all_years = overflow_count / total_count_all_years * 100) |>
  select(-total_count_all_years) |>
  arrange(county, year)
  
```

Q3: Which counties had the most severe sewer overflows (by quantity, time or both) and when did they occur?

```{r}

cleaned_sewer_overflows |>
  group_by(county) |>
  arrange(desc(net_in_gallons_estimated)) 




```

Q4: What is the average quantity of gallons of sewer overflows per event versus the estimated net in gallons?

There wasn't much code needed to calculate this value. I added the quantity_in_gallons_estimated column while removing any NA values and then divided by the total number of incidents. I then did same for the net_in_gallons_estimated column to see if there was a significant difference from the first column. I added the answers within each code block below.

```{r}

sum(cleaned_sewer_overflows$quantity_in_gallons_estimated, na.rm = TRUE) / 27479 
#Answer is 255380.5 gallons per event

```

```{r}

sum(cleaned_sewer_overflows$net_in_gallons_estimated, na.rm = TRUE) / 27479 
#Answer is 254185.4 gallons per event

```

Q5: Which Maryland watersheds have been most impacted by sewer overflows?

```{r}

cleaned_sewer_overflows |>
  group_by(receiving_waters) |>
  summarise(rw_incidents = n()) |> 
  filter(receiving_waters != "NA|N/A") |>
  arrange(desc(rw_incidents))

```

Q6: What are the most common types of sewer overflows? 

First, I made a new data frame that isolates blockage causes and a total count. I wasn't satisfied with this raw count because I was more interested in finding out the number of times they were either the sole and/or contributing factor in a sewer blockage.

```{r}

blockage_causes <- cleaned_sewer_overflows |>
  group_by(cause) |>
  summarise(cause_count = n()) |>
  filter(cause != "NA|N/A") |>
  mutate(cause = str_to_lower(cause)) |>
  arrange(desc(cause_count))

```

One method to accomplish this would be to filter the cause column in this data frame and string detect each major cause. However, this method would omit results nested within columns that have multiple causes contributing to a blockage.

```{r}
#Don't run this codeblock
blockage_causes |> 
  filter(str_detect(cause, "Precipitation")) |> 
    summarise(cause = "Precipitation", total = sum(cause_count))

```

Instead, I opted to create a 'for' loop. I first created a list of the most common factors contributing to sewer blockages and overflows. The next line of code "h = hash()" creates an empty hash in which we store key value pairs where the key is the 'cause' of the sewer overflow and the value is the count.

From there, I created the loop checking the data frame for each item in the list. Essentially, this loop is string detecting for each of these causes, then summarizing the count in which they appear. Finally, I wrote code to turn the result of the for loop into a separate data frame called 'cause_counts' that I could use to conduct further analysis.

```{r}

cause_list <- list("rags", "grease", "roots", "rain", "trash", "debris", "sand", "gravel", "rocks", "break", "malfunction", "excess", "fail", "vandalism", "defective", "error", "precipitation")

h = hash()

for (x in cause_list) {
 df =  blockage_causes |> 
    filter(str_detect(cause, x)) |> 
    summarise(cause = x, total = sum(cause_count))

  h[[x]] <- df$total

}

```

```{r}

hash_list <- list(causes = keys(h), counts = values(h))
cause_counts <- as.data.frame(hash_list)

```

With this last code block below, I can see that precipitation, rain, rags, grease and roots are the top five culprits. Precipitation and rain could mean the same thing, however, it's tough to know exactly how each were meant to be interpreted so I left them apart. I then took the total number of incidents (rows) from the original data frame and divided each count by that number to find the frequency in which these terms appeared in the cause column.

```{r}

cause_counts |>
  mutate(pct_cause = counts / (27479) * 100) |>
  arrange(desc(pct_cause))

```





